var Stream = require('stream');
var Hoek = require('hoek');
var Fs = require('fs');
var Through = require('through');


var goodStream = new Stream.Readable({ objectMode: true });
goodStream._read = Hoek.ignore;

var fileStream = Fs.createWriteStream(Hoek.uniqueFilename('.','.log'), { flags: 'a', end: false, encoding: 'utf8' });
var ts = Through(function write(data) {

    if (data.id % 2 === 0) {
        this.queue(JSON.stringify(data) + '\n');
    }
}, function end() {
    this.queue(null);
});

goodStream.pipe(ts).pipe(process.stdout);
goodStream.pipe(ts).pipe(fileStream);


for (var i = 0; i < 1000; ++i) {
    goodStream.push({
        time: Date.now(),
        id: i
    });
}

//goodStream.push(null);

setTimeout(function () {
    for (var i = 0; i < 1000; ++i) {
        goodStream.push({
            time: Date.now(),
            id: i,
            tag: 'second run'
        });
    }
}, 1000);

